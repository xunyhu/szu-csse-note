## 6.1 数据库完整性

1. 数据库的安全保护功能

   DBMS 对数据库的安全保护功能是通过`完整性控制`、`安全性控制`、`并发控制`和`数据库备份与恢复`四个方面来实现的。

2. 数据库完整性

   `数据库完整性`是指数据库中数据的`正确性`和`相容性`。

   数据完整性约束是为了`防止数据库中存在不符合语义的数据`，为了维护数据的完整性，DBMS 必须提供一种`机制`来检查数据库中的数据，以判断其是否满足语义规定的条件。 DBMS 检查数据是否满足完整性约束条件的机制称为`完整性检查`。

   在 MySQL 中，各种完整性约束可以通过`CREATE TABLE `或 `ALTER TABLE`语句定义。

3. **完整性约束条件的作用对象**

   `列级`约束

   `元组`约束

   `表级`约束

4. **三类不同的完整性约束**的实现方式

   `实体完整性`：通过`主键`完整性约束和`候选键`约束来实现。主键约束：`PRIMARY KEY`；候选键约束：`UNIQUE`；

   `参照完整性`：通过创建表或更新表的同时`定义一个外键声明`来实现

   `用户定义完整性`：`非空约束 NOT NULL`；`CHECK约束`，可以`对列或表`实施，语法 CHECK(expr)；`触发器`;

5. 外键声明的两种方式

   在 MySQL 中，参照完整性是通过在创建表(CREATE TABLE)或更新表(ALTER TABLE)的同时定义一个外键声明来实现的。其中，外键声明有下列两种方式 。

   （1）在表中某个列的属性`定义后直接加上reference_definition语法项`；

   （2）在表中所有`列的属性定义后添加FOREIGN KEY（index_col_name,...）reference_definition子句`的语法项。

   ```sql
     CREATE TABLE order1
     (
        order_id INT NOT NULL AUTO_INCREMENT,
        order_product CHAR(50) NOT NULL,
        order_product_type CHAR(50) NOT NULL ,
        cust_id INT NOT NULL ,
        order_date DATETIME NOT NULL ,
        order_amount INT NOT NULL ,
        PRIMARY KEY(order_id),
        FOREIGN KEY(cust_id) REFERENCES customers(cust_id) on delete restrict on update restrict
     );
   ```

6. 指定外键必须遵守如下规则
7. 用户自定义的完整性

   MySQL 支持几种用户自定义的完整性，分别是非空约束、CHECK 约束和触发器。

8. 命名完整性约束

   命名完整性约束的方法是在各种完整性约束的定义说明之前加上`关键字CONSTRAINT`和`该约束的名字`。

9. 更新完整性约束

   可以使用 ALTER TABLE 语句来更新与列或表有关的各种约束。比如可在 ALTER TABLE 语句中使用`ADD CONSTRAINT 子句`添加约束。

   注意：（1）`完整性约束不能直接被修改`，若要`修改要用ALTER TABLE先删除约束，再增加一个与该约束同名的新约束`；  
   （2）使用`ALTER TABLE语句`，可以独立地删除完整性约束，而不会删除表本身，若使用`DROP TABLE`删除一个表，则表中所有的完整性约束都会自动被删除

## 6.2 触发器

1.  触发器

    触发器(Trigger)是用户定义在关系表上的一类`由事件驱动的数据库对象`，`也是一种保证数据完整性的方法`。触发器一旦定义，无须用户调用，任何对表的修改操作均由数据库服务器自动激活相应的触发器。 例如每当客户订购一个产品时，都从产品库存量中减去可订购的数量；每当删除客户基本信息表中一个客户的全部基本信息数据时，该客户所订购的未完成订单信息也应该被自动删除。

    `触发器的主要作用`：实现主键和外键不能保证的复杂的参照完整性和数据的一致性，从而有效地保护表中的数据。

2.  创建触发器

    在 MySQL 中，可以使用`CREATE TRIGGER语句创建触发器`

    其语法格式：CREATE TRIGGER trigger_name trigger_time trigger_event ON tbl_name FOR EACH ROW trigger_body

    说明：（1）trigger_name:指定触发器的名称；  
     （2）trigger_time:指定触发器被触发的时刻，有`两个选项：BEFORE 和 AFTER`；  
     （3）trigger_event：指定触发事件，即指定`激活触发器`的语句的种类：`INSERT、UPDATE 和 DELETE`  
     （4）tbl_name：指定与触发器相关联的表名，必须引用永久性表；  
     （5）FOR EACH ROW：指定对于受触发事件影响的每一行都要激活触发器的动作；  
     （6）trigger_body：指定触发器动作主体，即包含触发器激活时将要执行的 MySQL 语句。如果要执行多个语句，可使用 BEGIN…END 复合语句结构；  
     在触发器的创建中，每个表每个事件每次只允许一个触发器。因此，`每个表最多支持6个触发器`

    ```sql
     CREATE TRIGGER mysql_test.customers_insert_trigger AFTER INSERT ON mysql_test.customers FOR EACH ROW SET @str='one customer added!';

     //插入以下数据：
     insert into customers values(5, '万华','F','长沙市','芙蓉区', NULL);

     //查看触发器
     select @str;
    ```

3.  删除触发器

    在 MySQL 中，可以使用 `DROP 语句`将触发器从数据库中删除，其语法格式：DROP TRIGGER [IF EXISTS] [schema_name.]trigger_name  
    说明：（1）`IF EXISTS`:用于避免在没有触发器的情况下删除触发器；  
    （2）schema_name:指定触发器所在数据库的名称；  
    （3）trigger_name：指定要删除的触发器名称。

    ```sql
      DROP TRIGGER IF EXISTS mysql_test.customers_insert_trigger;
    ```

4.  使用触发器

## 6.3 安全性与访问控制

1. 数据库的安全性

   `数据库的安全性`是指保护数据库以防止不合法的使用而造成数据泄露、更改或破坏。

   数据库系统对数据的`安全管理`是使用身份验证、数据库用户权限确认等访问控制措施，来保护数据库中的信息资源，以防止这些数据遭受破坏。

2. 用户账号管理

   MySQL 的用户账号及相关信息都存储在一个名为 mysql 的 MySQL 数据库中，这个数据库里有一个`名为user的数据表，包含了所有用户账号`，并且它用一个名为 user 的列存储用户的登录名。可以使用下面的 SQL 语旬查看 MySQL 数据库的使用者账号。

   ```sql
      select user from mysql.user;
   ```

   作为一个新安装的系统，当前只有一个名为 root 的用户。这个用户是在成功安装 MySQL 服务器后，由系统创建的，并且被赋予了操作和管理 MySQL 的所有权限。因此，`root 用户拥有对整个MySQL服务器完全控制的能力`。

   为了避免恶意用户冒名使用 root 账号操控数据库，通常需要创建一系列具备适当权限的账号，而`尽可能地不用或少用root账号登录系统，以此来确保数据的安全访问`。

3. 创建用户账号

   可以使用`CREATE USER语句`来创建一个或多个 MySQL 账户，并设置相应的口令, 其语法格式： CREATE USER user[IDENTIFIED BY [PASSWORD] ‘password’]

   注意：（1）要`使用 CREATE USER 语句`，`必须拥有` MySQL 中 mysql 数据库的 `INSERT 权限或全局 CREATE USER` 权限；  
    （2）使用 CREATE USER 语句创建一个用户账户后，会在系统自身的 mysql 数据库的 user 表中添加一条新记录；  
    （3）如果两个用户具有相同的用户名和不同的主机名，MySQL 会将它们视为不同的用户，并允许为这两个用户分配不同的权限集合；  
    （4）如果在 CREATE USER 语句的使用中，没有为用户指定口令，那么 MySQL 允许该用户可以不使用口令登录系统；  
    （5）新创建的用户拥有的权限很少

4. 删除用户账号

   可以使用 `DROP USER 语句`来删除一个或多个用户账户以及相关的权限，其语法格式：DROP USER user[,user]…

   说明：（1）DROP USER 语句`可用于删除一个或多个` MySQL 账户，并消除其权限；  
   （2）要使用 DROP USER 语句，必须拥有 MySQL 中 mysql 数据库的 `DELETE 权限`或`全局 CREATE USER` 权限；  
   （3）在 DROP USER 语句的使用中，如果没有明确地给出账户的主机名，则该主机名会默认为%；  
   （4）用户的删除不会影响到他们之前所创建的表、索引或其他数据库对象。

5. 修改用户账号

   可以使用 `RENAME USER 语句`修改一个或多个已经存在的 MySQL 用户账户，其语法格式：RENAME USER old_user TO new_user[,old_user TO new_user]…
   其中：（1）old_user：指定系统中已经存在的 MySQL 用户账号；  
    （2）new_user：指定新的 MySQL 用户账户。

   说明：（1）RENAME USER 语句用于对原有 MySQL 账户进行重命名；  
   （2）要使用 RENAME USER 语句，必须拥有 MySQL 中 mysql 数据库的 `UPDATE 权限`或`全局 CREATE USER` 权限；  
   （3）如果系统中旧账户不存在或新账户已存在，则语句执行会出现错误。

6. 修改用户口令

   可以使用`SET PASSWORD语句`修改一个用户的登录口令

7. 账户权限管理

   成功创建用户账号后，需要为该用户分配访问适当的权限，因为新创建的用户账号没有访问权限，只能登录 MySQL 服务器，不能执行任何数据库操作。  
   例如，使用 `SHOW GRANTSFOR 语句`就可以查看前面新创建的用户 wangwu 的如下授权表

8. 权限的授予

   新建的 MySQL 用户必须被授权，可以使用`GRANT语句`来实现

9. 权限的转移
10. 权限的撤销

    当需要撤销一个用户的权限、而又不希望将该用户从系统中删除时，可以使用`REVOKE 语句`来实现。

## 6.4 事务与并发控制

1. 事务与并发控制

   数据库中的数据是共享的资源，因此数据库系统通常都是多用户系统，即支持多个不同程序或同一程序的多个独立执行同时（或称并发地）存取数据库中相同的数据。当多个用户同时操作相同的数据时， 如果不采取任何措施，则会造成数据的异常现象。

   因此，DBMS 必须对这种并发操作提供一定的控制，以防止它们彼此干扰，从而保证数据库的正确性不被破坏，避免数据库的不一致性，这种机制就称为“并发控制”。其中，`事务就是为保证数据的一致性而产生的一个概念和基本手段。`

2. 事务的概念

   `所谓事务`是用户定义的一个数据操作序列，这些操作可作为一个完整的工作单元，`要么全部执行，要么全部不执行，是一个不可分割的工作`。例如在在关系数据库中， `一个事务可以是一条 SQL 语句、一组 SQL 语句或整个程序。`

   事务与程序很相似，但它们是两个彼此相联而又不同的概念：`程序是静止的，事务是动态的`，是程序的执行而不是程序本身；同一程序的多个独立执行可以同时进行，而每一步执行则是一个不同的事务。

   要让 DBMS 知道哪些动作属一个事务，而不是单纯的数据库操作或程序，必须要显式地告诉数据库系统，这可以通过标记事务的开始与结束来实现。`在 SQL 中，用户显式定义事务的语句一般有这样三条：BEGIN TRANSACTION、 COMMIT 和 ROLLBACK`, 且事务通常是`以 BEGIN TRANSACTION 语句开始，以 COMMIT 语句或 ROLLBACK 语句结束`。  
   其中 `COMMIT 语句表示提交`， 即提交事务的所有操作，具体地说就是将事务中所有对数据库的更新写回到磁盘上的物理数据库中去，事务正常结束；  
   `ROLLBACK语句表示回滚`，即在事务运行的过程中若发生了某种故障，事务不能继续执行，系统将事务中对数据库的所有已完成的操作全部撤销，回滚到事务开始时的状态。事务中的操作一般是对数据的更新操作，包括增、删、改。

3. 事务的特征

   为了保证数据的一致性和正确性，数据库系统必须保证`事务具有四个特征`， 即`原子性（Atomicity）、一致性(Consistency)、隔离性(Isolation)和持续性（Durability）`。这四个特征也简称为事务的 ACID 特征。

4. 并发操作问题

   `事务是并发控制的基本单位`，保证事务的 ACID 特征是事务处理的重要任务，而事务的 ACID 特征可能遭到破坏的原因之一是多个事务对数据库的并发操作造成的。为了保证事务的隔离性和一致性，DBMS 需要对并发操作进行正确调度。其中完整性检验可以保证一个事务单独执行时，若输入的数据库状态是正确的，则其输出的数据库状态也是正确的。但当多个事务交错执行时，可能出现不一致问题，这也称为并发操作问题，典型的有如下三种：`丢失更新、不可重复读和读“脏”数据`

5. 封锁

   封锁是最常用的并发控制技术，它的基本思想是：需要时，事务通过向系统请求对它所希望的数据对象（如数据库中的记录）加锁，以确保它不被非预期改变。

   一个锁实质就是允许或阻止一个事务对一个数据对象的存取特权。一个事务对一个对象加锁的结果是将别的事务“封锁”在该对象之外，特别是防止了其他事务对该对象的变更， 而加锁的事务则可执行它所希望的处理并维持该对象的正确状态。

   基本的封锁类型有两种： 排他锁（Exclusive Lock, X 锁）和共享锁（share Lock，S 锁）。一般地，写操作要求 X 锁，读操作要求 S 锁。

6. 封锁的工作原理

7. 封锁的粒度

8. 封锁的级别

9. 活锁与死锁

10. 可串行性

11. 两段封锁法

## 6.5 备份与恢复

1. 可能会造成数据库运行事务异常中断的因素

   计算机硬件故障；计算机软件故障；病毒；人为误操作；自然灾害；盗窃；

   面对这些可能的因素会造成数据丢失或被破坏的风险，数据库系统提供了备份和恢复策略来保证数据库中数据的可靠性和完整性。

   `数据库备份`：通过导出数据或者复制表文件的方式来制作数据库的复本。

   `数据库恢复`：当数据库出现故障或遭到破坏时，将备份的数据库加载到系统，从而使数据库从错误状态恢复到备份时的正确状态。

   `数据库的恢复是以备份为基础的`，它是与备份相对应的`系统维护`和`管理`操作。

2. 备份数据

   语法格式：`SELECT \* INTO OUTFILE ‘file_name’ export_options |INTO DUMPFILE ‘file_name’`

3. 恢复数据

   语法格式：`LOAD DATA INFILE ‘file_name’ INTO TABLE tbl_name ....`
