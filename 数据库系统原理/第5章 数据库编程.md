## 5.1 存储过程

1. 存储过程的基本概念

   在多数情况下，许多代码会被重复使用多次，且每次都会输入相同的代码，这样既繁琐又会降低系统的运行效率。因此，需要提供一种方法，它可以`将些固定的操作集合起来`，由数据库服务器来完成，实现某个特点任务，`这就是存储过程`。

   存储过程是一组为了完成某项特定功能的` SQL 语句集`，其实质就是一段存储在数据库中的代码，它可以由`声明式的 SQL 语句`和`过程式 SQL 语句`组成。这些语句集经过编译后存储在数据库中，用户通过指定存储过程的名字和参数来调用并执行存储过程，而不必重新编译。

   一个存储过程是一个可编程的函数，同时可看作是在数据库编程中面向对象方法的模拟，它允许控制数据的访问方式。当希望在不同的应用程序或平台上执行相同的特定功能时，存储过程尤为合适。

   使用`存储过程的好处`：

   - 1）可增强 SQL 语言的功能和灵活性；
   - 2）良好的封装性；
   - 3）高性能；
   - 4）`可减少网络流量`；
   - 5）存储过程作为一种安全机制来确保`数据库的安全性`和数据的`完整性`。

2. 创建存储过程

   `DELIMITER`：用于将 MySQL 语句的`结束标志临时修改为其他符号`，从而使得 MySQL 服务器可以完整地处理存储过程体中所有的 SQL 语句。  
   在 MySQL 中，服务器处理 SQL 语句默认是以分号作为语句的结束标志。  
   语法格式：`DELIMITER $$` 其中$$是用户定义的结束符，要避免使用反斜杠（\）

   ```sql
      //将MySQL结束符修改为两个感叹号”!!”

      delimiter !!
   ```

   在 MySQL 中，是使用`CREATE PROCEDURE语句`来创建存储过程

   存储过程的主体部分，也称为存储过程体，包含了在过程调用的时候必须执行的 SQL 语句。这个部分`以BEGIN开始，以END结束`。

   在数据库 mysql_test 中创建一个存储过程，用于实现给定表 customers 中一个客户 id 号即可修改表 customers 中该客户的性别为一个指定的性别。

   ```sql
      USE mysql_test;
      DELIMITER $$
      CREATE PROCEDURE sp_update_sex(IN cid INT,IN csex CHAR(1))
      BEGIN
      UPDATE customers SET cust_sex=csex WHERE cust_id=cid;
      END $$
      DELIMITER ;
   ```

3. 存储过程体常用语法元素

   `局部变量`：在存储过程体中可以使用`DECLARE语句`声明局部变量，用来存储存储过程体中的临时结果。

   例 5.3：声明一个整型局部变量 cid。`DECLARE cid INT(10);`

   局部变量不同于用户变量，两者间的区别：  
    局部变量声明时，在其前面没有使用@符号，并且只能被声明它的 BEGIN...END 语句块中的语句所使用；  
    `用户变量`声明时，会在其名称前`使用@符号`，同时已声明的用户变量`存于整个会话之中`。

   在 MySQL 中，可以在存储过程体中，`使用条件判断语句和循环语句`这样两类用于控制语句流程的过程式 SQL 语句。

   条件判断语句：IF…THEN…ELSE 和 CASE

   循环语句：WHILE 语句、REPEAT 语句和 LOOP 语句。可以使用 ITERATE 语句退出当前循环，重新开始一个循环。

   `游标`是一个被 SELECT 语句检索出来的结果集。在存储了游标后，应用程序或用户就可以根据需要滚动或浏览其中的数据。使用的步骤如下：
   （1）声明游标：`DECLARE CURSOR`  
   （2）打开游标：`OPEN `
   （3）读取数据：FETCH…INTO  
   （4）关闭游标：CLOSE

4. 调用存储过程

   创建好存储过程后，可以使用`CALL 语句`在程序或其他存储过程中调用。

5. 删除存储过程

   在 MySQL 中，可以使用 `DROP PROCEDURE 语句`删除数据库中已创建的存储过程。

## 5.2 存储函数

1. 存储函数

   存储函数与存储过程的相同点和不同点。

   相同点：由 SQL 语句和过程式语句所组成的`代码片断`，并且可以被应用程序和其他 SQL 语句调用。

   不同点：  
   （1）`存储函数自身就是输出参数，不能拥有输出参数；存储过程可以拥有输出参数`；  
   （2）存储函数可以直接被调用，`不需要使用CALL语句`；存储过程的调用需要使用 CALL 语句；  
   （3）`存储函数必须包含一条 RETURN 语句`；存储过程不允许包含 RETURN 语句。

2. 存储函数语法

   在 MySQL 中，使用 `CREATE FUNCTION 语句`来创建存储函数

## 本章用到的 sql 语句

1. 创建存储过程`create procedure`
2. 修改结束语句`delimiter`
3. 声明变量`declare`
4. 创建游标`declare cursor`
5. 调用存储过程`call`
6. 删除存储过程`drop procedure`
7. 创建存储函数`create function`
