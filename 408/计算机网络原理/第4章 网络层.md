## 第四章 网络层

### (一)、网络层服务

- 概念：
  - 网络层是介于传输层与数据链路层之间，传输层提供端到端的进程间通信服务，数据链路层提供物理链路层直接相连的两个结点之间的数据帧传输服务，
  - **网络层关注的是如何将承载传输层报文段的网络层数据报从源主机送达目的主机。**
- 网络层两项重要功能：
  - 1.转发。通过一条输入链路接收到一个分组后，路由器需要决策通过哪条输入链路将分组发送出去，并将分组从输入接口转移到输出接口。
  - 2.路由选择。当分组从源主机流向目的主机时，必须通过某种方式决定分组经过的路由或路径，计算分组所经过的路径的算法被称为路由选择算法，或称为路由算法。
    - 路由选择通过路由选择算法来实现
    - 路由器转发表：交换或收集路由信息；计算路由；路由信息存储在转发表

### (二)、数据报网络与虚电路网络

1. 数据报网络

   - 概念：按照目的主机地址进行路由选择的网络称为数据报网络。因特网的 IP 都是按照目的地址进行路由选择的，因此因特网是一个数据报网络。
   - 特点：
     - 数据报中每个分组都被单独处理，`每个分组称为一个数据报`，每个数据报都携带源主机地址和目的主机地址的信息。在双方开始通信之前，不需要建立连接，因此被称为`“无连接”`。
     - 分组到达交换机时，交换机检查该分组的目的地址，然后转发给某台相邻的交换机。这个过程，交换机需要有一个目的地址——输出链路映射关系的`转发表`。
     - 接收方收到分组后要根据相应的协议，对分组重新排序，从而生成原始的完整报文，这个任务通常由传输层来完成。

2. 虚电路网络

   - 概念：虚电路在网络层提供面向连接的分组交换服务。
   - 特点：
     - 通信之前，双方需要先建立虚电路，结束后再拆除虚电路
     - 虚电路是在源主机到目的主机的一条路径上建立的一条网络层逻辑连接，为了区别于电路交换中的电路，称之为虚电路。
     - 每条虚电路有虚电路号**VCID**
   - 虚电路三个要素
     - 1.从源主机到目的主机之间的一条路径（即一系列的链路和分组交换机）
     - 2.该路径上的每条链路各有一个虚电路标识（VCID）
     - 3.该路径上每台分组交换机的转发表中记录虚电路标识的接续关系。
   - 虚电路两种类型
     - 1.永久型。是一种提前建立、长期使用的虚电路，虚电路的建立时间开销基本上可以忽略。
     - 2.交换型。是根据通信需要而临时建立的虚电路，通信结束后立即拆除，虚电路的建立和拆除时间开销有时相对影响较大。

3. 虚电路与数据报网络的区别
   - 主要差别在于是将顺序控制、差错控制和流量控制等功能交由网络来完成，还是由端系统来完成。
   - 虚电路网络（如 ATM 网络）通常由网络完成这些功能，而端系统则可以很简单。
   - 数据报网络（如 Internet）通常网络实现的功能很简单，如基本的路由与转发，而顺序控制、差错控制和流量控制等功能则由端系统来完成。

### (三)、网络互连与网络互连设备

1. 异构网络互联

   - 异构网络概念：网络拓扑中存在许多不同类型的网络，如 WAN、LAN 等，网络层的下一层数据链路层使用了多种不同的协议如以太网、802.11 等，在网络的各个层次广泛应用着大量协议，网络之间是异构的。
   - 异构网络主要是指两个网络的通信技术和运行的协议的不同。
   - 异构网络的互联策略：
     - 协议转换。通过路由器、交换机、应用网关等。
     - 构建虚拟互连网络。在现有异构的基础上，构建一个同构的虚拟互联网络，异构网络均只需要封装虚拟互联网分组，通过中间设备互联异构网络，实现转发虚拟互联网的数据分组。
     - IP 网络就是虚拟互联网，Internet 利用 IP 网络实现全球互联，采用同构的网络层协议——IP 与网络寻址——IP 地址，引入网络互联设备——IP 路由器。
   - 除了异构网络互联之外，`同构网络互联的典型技术是隧道技术`。

2. 路由器
   - 概念：路由器是一种具有多个输入端口和多个输出端口的专用计算机，主要任务是获取与维护路由信息以及转发分组。从功能角度，可以分为输入端口、交换结构、输出端口与路由处理器。
   - 1.输入端口
     - 输入端口从物理接口接收信号，还原数据链路层帧，提取 IP 数据报根据 IP 数据报的目的 IP 地址检索路由表，决策需要将该 IP 数据报交换到哪个输出端口。
   - 2.交换结构
     - 概念：输入端口决策分组要转发到哪个输出端口后，具体的转发工作由交换结构来完成。
     - 3 种交换结构：
       - 基于内存交换。性能最低，但是价格最便宜。
       - 基于总线交换
       - 基于网络交换。性能最好，价格最贵。
   - 3.输出端口
     - 从链路层的帧组装成数据报
   - 4.路由处理器
     - 路由处理器是路由器的 CPU，复制执行路由器的各种指令，包括路由协议的运行、路由计算以及路由表的更新维护等。
     - `转发与路由选择`是路由器两项最重要的基本功能。

### (四)、网络层拥塞控制

1. 网络拥塞

   - 概念：网络中需要传输的信息总量大于其传输能力，以至于某些网络节点（如路由器）因缓冲区已满，无法接收新到达的分组，此时就发生了拥塞现象。
   - 拥塞是一种赤溪过载的网络状态，此时用户对网络资源（包括链路带宽、存储空间和处理器能力等）的总需求超过了网络固有的容量。
   - 发生拥塞的原因主要有 4 种：1.缓冲区容量有限；2.传输线路的带宽有限；3.网络结点的处理能力有限；4.网络中某些部分发生了故障。

2. 流量感知路由

   - 概念：根据网络负载动态调整，将网络流量引导到不同的链路上，均衡网络负载，从而延缓或避免拥塞的发生。流量感知路由是一种拥塞预防措施。

3. 准入控制

   - 准入控制是一种广泛应用于虚电路网络的拥塞预防技术。

4. 流量调节

   - 在网络发生拥塞时，可以通过调整发送方向网络发送数据的速率来消除拥塞。
   - 流量调节需要解决两个基本问题
     - 如何感知以及发生了拥塞？ 通过路由器过去一段时间内的排队延迟及当前的瞬时排队延迟的加权组合来评判。
     - 如何通知到其上游结点？
       - 1.抑制分组。给数据报的源主机返回一个抑制分组。
       - 2.背压。使抑制分组发挥作用的背压方法，可以使拥塞节点很快得到缓解，代价使抑制分组的每一跳都需要分配更大的缓冲区。

5. 负载脱落
   - 负载脱落使消除拥塞的另一种方法，即通过有选择地主动丢弃一些数据报，来减轻网络负载，从而缓解或消除拥塞。

### (五)、Internet 网络层

1. Internet 网路层主要协议：**IP 协议、路由协议、ICMP 协议**

   - IPv4 结构表格与字段含义
   - ![image](https://akaedu.github.io/book/images/tcpip.ipformat.png)
   - [IPv4 数据报的格式](https://www.jianshu.com/p/809dca1072fc)

2. IP 数据报分片

   - `MTU(最大传输单元)最大 1500 字节`
   - IP 数据报的标志字段占 3 未，其中最高位保留，DF(Don't Fragment)是禁止分片标志，MF(More Fragment)是更多分片标志。
     - DF=0 表示允许分片，DF=1 表示禁止分片。
     - MF=0 表示该 IP 数据报是一个未被分片的 IP 数据报或者是被分片 IP 数据报的最后一片，具体是哪种要结合片偏移字段确定。
     - MF=1 表示一定是一个 IP 数据报的分片，并且不是最后一个分片。
     - 片偏移量为 0 时，MF=0 表示是一个未被分片的数据报，MF=1 表示是一个分片且是第一个分片。
   - 掌握 P146-147 实例，理解表格计算

3. IPv4 编址格式：

   - 长度是 32bit，常用四个十进制数方便表示，以"."分隔
   - 每个整数对应 8bit 二进制码，所以每个整数范围 0~255
   - 十进制整数是为了方便用户记忆，实际上网络底层全部用二进制表示
   - 还有十六进制表示方式

4. 掌握 IP 地址三种格式的转换

   - 熟背十进制转二进制
   - 2^4=16,2^5=32,2^6=64,2^7=128,2^8=256,2^9=512,2^10=1024

5. 一个**IP 地址分为两个部分：子网地址（前缀）+ 主机地址（后缀）**  
   IPv4 分类地址：前缀部分长度固定，分为 ABCDE

   - A 类，1+3，首数字 0-127（第一位 10 进制数，8 个 0~8 个 1）
   - B 类，2+2，首数字 128-191
   - C 类，3+1，首数字 192-223
   - D 类，特殊用途，首数字 224-239
   - E 类，特殊用途，首数字 240-255
   - 熟背 ABC 类的网络数量和 IP 地址总数

6. 子网划分，采用 CIDR 技术，通过子网掩码标识子网地址长度

   - 子网表示一段范围内的 IP 地址，子网内的 IP 直接相互通信，无需再寻址
   - **IP 地址=子网地址+主机地址/子网掩码**
     - 子网地址格式上是一个 IP 地址，含义是一个子网，表示一段范围内的 IP
     - 主机地址格式上是一个 IP 地址，含义是一个子网中某台电脑的 IP
     - 子网掩码格式上是一个 IP 地址，含义是表示子网的范围
     - 子网地址=IP 地址 and 子网掩码
   - 子网掩码的含义
     - 子网掩码是 32bit 中，前 n 个位是 1，后（32-n）个位是 0，不存在 0 与 1 混杂，必定是前 1 后 0
     - 若掩码中 1 个数是 x，则 2^(32-x)表示子网的 IP 数
   - 给出任意 IP 地址和掩码长度 n,求解子网参数
     - 子网参数：子网掩码\子网地址\广播地址\IP 地址总数\可分配 IP 地址范围
     - 子网地址 = IP 地址 and 子网掩码
     - IP 地址总数 = 32-n，做 2 的 n 次方
     - 广播地址 = 子网地址 + IP 总数 - 1
     - 可分配 IP 地址 = IP 总数 - 2
     - 分配 IP 地址范围最小值 = 子网地址 + 1
     - 分配 IP 地址范围最大值 = 广播地址 - 1 = 子网地址 + IP 总数 - 2
     - 在一个子网段中，首尾四个 IP 地址含义
       - 第 1 个 IP 是子网地址，第 2 个 IP 是最小可分配 IP 地址
       - 倒数第 2 个 IP 是最大可分配地址，最后一个 IP 是广播地址
     - 以上公式是假设主机地址集中在 IP 的第 4 个数字
     - 如果主机地址跨越了 IP 第 3、4 个数字，要找出第 3 个数字表示主机的长度
       - 子网地址 = 公式不变
       - IP 地址总数 = 公式不变
       - 广播地址 = 前 2 个数字不变+第 3 数字+主机部分表示最大值+第 4 数字+255
       - 可分配 IP 地址 = 公式不变
       - 分配 IP 地址范围最小值 = 公式不变
       - 分配 IP 地址范围最大值 = 公式不变
   - 子网掩码划分子网
     - 子网掩码 32bit 从高到低，每把一个 0 变成 1，子网就划分为 2 个子网，IP 总数和 IP 范围就分为两半
     - 一般情况下，对半分的两个小子网规则
       - 第一个小子网的子网地址=原子网地址，原掩码+1,
       - 第二个小子网的子网地址=原子网地址+半 IP 总数，原掩码+1,
       - 这里的掩码加 1 是指 1 的个数加 1，不是十进制数值加 1

7. 路由聚合

   - 路由聚合是为了提高路由效率，减少路由表项数，尽可能将能够聚合在一起的子网聚合成一个大的子网。路由聚合可以视为是子网划分的逆过程。

8. 动态主机配置协议 DHCP

   - 当一个组织分配到一个网络地址块后，就可以为该组织内的主机和路由器接口分配 IP 地址。可以由网管手动配置，也可以通过动态主机配置协议（DHCP）来动态分配。
   - DHCP 服务过程
     - DHCP 在应用层实现，传输层使用 UDP。
     - 提供动态 IP 地址分配的网络，需要运行 DHCP 服务器（端口号为 67），并配置其可以为其他主机进行动态地址分配的 IP 地址范围等。

9. 网络地址转换 NAT

10. 互联网控制报文协议 ICMP

    - 作用：在主机或路由器间，实现差错信息报告。因此 ICMP 的主要功能是进行主机或路由器间的网络层差错报告与网络探测。
    - ICMP 报文格式
    - ICMP 报文类型

11. IPv6
    - IPv6 地址空间巨大
    - IPv6 地址格式
      - 长度是 128bit，用 8 组十六进制表示，每组 16bit 用 4 个十六进制数
      - 连续多组 0000 可以用::压缩表示，只能用一次
      - 最后 32bit 可以点分十进制混合表示，即十六进制和点十进制混合组合，或全点分十进制都可以

### (六)、路由算法与路由协议

1. 路由选择问题实际就是选择最佳路径
2. 把网络抽象成为带权无向图
3. 路由算法分为

   - 全局式路由选择
     - 链路状态路由选择算法，简称 LS 算法
     - 迪杰斯特拉算法
   - 分布式路由选择
     - 距离向量路由选择算法，简称 DV 算法

4. 层次化路由选择

   - 自治系统
   - 自治系统间路由协议

5. Internet 路由选择协议
   - 分为 IGP 和 BGP
     - IGP：RIP 协议、用跳数来衡量；OSPF 协议，基于链路状态选择算法；
     - BGP: BGP，BGP4

### 考核内容与要求

- 网络层服务
  - 识记：网络层服务
  - 领会：网络层寻址；转发与路由的基本概念；转发与路由的区别与联系
- 数据报网络与虚电路网络
  - 识记： 虚电路网络特点；数据报网络特点
  - 领会：虚电路网络工作过程；数据报网络工作过程；虚电路网络的转发与路由；数据报网络的转发与路由；虚电路网络的转发表；数据报网络的转发表
- 网络互连与网络互连设备
  - 领会：网络互连的必要性；网络互连的基本方法；典型网络互连设备；路由器体系结构。
- 网络层拥塞控制
  - 识记：网络层拥塞基本概念；拥塞控制基本策略
  - 领会：流量感知路由基本原理；准入控制基本原理；流量调节基本方法；负载脱落基本原理
- Internet 网络层
  - 识记：Internet 网络层主要协议及其功能；IP 数据报结构。
  - 领会：MTU 的基本概念；特殊 IP 地址；私有 IP 地址；ICMP；DHCP；默认网关；NAT 的原理。
  - 应用：IP 数据报的分片；IP 地址；子网划分与子网掩码；CIDR；路由聚合；路由表。
- 路由算法与路由协议
  - 识记：路由选择基本原理；路由算法分类
  - 领会：链路状态路由算法基本原理；距离向量路由算法基本原理；层次化路由基本原理；RIP；OSPF；BGP。
  - 应用：基于链路状态路由算法的路由计算；基于距离向量路由算法的路由计算；距离向量路由算法的无穷计数问题分析。
    **重点、难点**  
    本章重点是转发与路由概念的理解、虚电路网络与数据报网络工作原理、IP 数据报结构、IP 数据报分片、IP 地址、子网划分、子网掩码、CIDR、路由聚合、路由表、ICMP、DHCP、NAT、链路状态路由算法、距离向量路由算法、层次化路由、RIP、OSPF、BGP 基本工作过程；
    本章难点是 IP 数据报分片、IP 地址、子网划分、子网掩码、CIDR、路由聚合、路由表、路由计算、层次化路由、OSPF、BGP。

#### 参考阅读

[深入理解计算机网络（四）：网络层](https://www.taogenjia.com/2019/09/05/computer-network-4-network-layer/)
