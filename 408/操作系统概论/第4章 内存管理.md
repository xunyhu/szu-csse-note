## 内存管理

- 概念：内存是计算机系统的重要组成部分，当操作系统接收到运行某程序的命令后，要为该程序的运行分配内存资源，创建进程，并把进程的全部或部分调入内存。进程运行结束，系统要回收被撤销进程的内存空间。
- 内存管理的目标：1.实现内存分配、内存回收等基本内存管理功能；2.提高内存空间的利用率和内存的访问速度。
- 关于内存管理，需要掌握：
  - 1.计算机硬件为程序的运行提供了什么样的存储器使用方式。
  - 2.操作系统为应用程序的运行提供了什么样的存储服务。
  - 3.操作系统怎样将多个不同的用户进程放在一个内存中，并使它们不相互干扰地并发执行。
  - 4.操作系统如何为进程提供远比物理内存大得多的虚拟内存空间。

## 4.1 存储器层次结构

1. 存储器系统

   - 概念：是一个具有不同容量、成本和访问时间的存储设备的层次结构。从快到慢依次为：**CPU 寄存器、高速缓存、主存、磁盘**；
   - ![image](https://pic2.zhimg.com/80/v2-c1297fb67384eb6ef18f4f6b5d4fa54d_720w.webp)
   - 从高层到低层（L0~L5），较低层的存储设备速度更慢、容量更大、价格更便宜。在最高层（L0），是少量的快速 CPU 寄存器，CPU 可以在一个时钟周期内访问它们。
     - CPU 寄存器保存最常用的数据
     - 高速缓存存储器作为速度相对较慢、容量较大的主存中数据和指令子集的缓存区
     - 主存暂时存放存储量更大、速度更慢的磁盘上的数据
     - 磁盘常常又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区

2. 程序执行的局部性原理

   - 1）程序执行时，除了少部分的转移和过程调用指令外，在大多数情况下仍是顺序执行的。
   - 2）过程调用将会使程序的执行轨迹由一部分区域转至另一部分区域，但经研究看出，过程调用的深度在大多数情况下都不超过 5。
   - 3）程序中存在很多循环结构，它们虽然由少数指令构成，但多次执行。
   - 4）程序中往往包括许多对数据结构的处理，例如对数组进行操作，它们往往都局限在很小的范围内。

3. 局部性原理表现在两个方面
   - 1）时间局限性。如果程序中的某条指令一旦执行，则不久以后该指令可能再次执行；如果某数据被访问过，则不久以后该数据可能再次被访问。
     - 典型是在程序中存在着大量的循环操作
   - 2）空间局限性。一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也将被访问，即程序在一段时间内所访问的地址，可能集中在一定的范围之内。
     - 典型是程序的顺序执行

## 4.2 程序的链接和装入

高级语言程序必须经过编译、链接才能成为可执行程序，操作系统需要为程序的执行分配空间。

- 程序进入内存的流程步骤
  - 编译：源代码->目标模块
  - 链接：目标模块+库函数->装入模块
  - 装入：装入内存

1. 程序的链接

   - 1）静态链接
     - 程序运行之前，先将各目标模块及它们所需的库函数，链接成一个完整的装配模块，以后不再拆开
   - 2）动态链接
     - 程序执行中需要该目标模块时，才对它进行的链接
     - 执行过程中，当发现一个被调用模块尚未装入内存时，立即由 OS 去找到该模块并将之装入内存，把它链接到调用者模块
     - 不用的目标模块不会被调入内存和被链接到装入模块
     - 加快程序的装入过程，而且可节省大量的内存空间

2. 程序的装入
   - 1）绝对装入方式
     - 绝对映射，程序中逻辑地址与内存物理地址完全相同
       - 程序的逻辑地址与实际内存地址相同
   - 2）可重定位装入方式（静态重定位）
     - 静态映射，在装入时对逻辑地址进行修改
       - 在装入时对逻辑地址做一次性修改，以后不再改变
   - 3）动态运行时装入（动态重定位）
     - 逻辑地址到物理地址的映射在程序运行时才执行
       - 地址转换到程序真正要执行时才执行
       - 装入内存后的所有地址都仍是相对地址

## 4.3 连续分配存储管理方式

连续分配是指操作系统分配内存时，为每个进程分配一块物理地址连续的内存空间。

1. 单一连续区分配

   - 一个用户程序独占连续的内存用户空间
   - 用于单用户、单任务的 OS 中
   - 内存只分为两个区：系统区和用户区
   - 一般对系统区作保护，用基址寄存器做控制

2. 固定分区分配

   - 将内存划分多个区域，每个区域大小固定
   - 每个区域职能装入一个程序
   - 分区大小相等的划分方法，一般用于多个相同任务
   - 分区大小不等的划分方法，根据实际任务大小分配
   - 缺点：固定分区分配容易造成浪费

3. 动态分区分配
   - 特点
     - 无固定分区，在整块内存空间中动态分割
     - 无用户程序，内存是一整块连续分区
     - 根据程序大小动态地分配连续的内存空间，分配的内存大小等于程序大小
   - 关键元素
     - 分区数据结构；分配算法；分配和回收操作
   - 数据结构
     - 空闲分区表；**空闲分区链**;
   - **动态分区分配算法**
     - 首次适应（FF）：按顺序选择第一个满足要求的内存区域
     - 循环首次适应（NF）：在上一次找到空闲分区的下一个分区开始寻找，找到第一个满足要求的内存区
     - 最佳适应（BF）：在所有空闲分区中查找与程序大小最相近的空闲分区
   - 动态分区分配的流程
     - 内存分配流程
     - 内存回收流程

## 4.4 基本分页存储管理方式

把进程`离散地存储在内存中`物理地址不连续的区域中，这种内存管理方式称为离散内存管理方式。  
根据离散内存管理分配内存空间的基本单位的不同，分为 3 种不同的管理方式：`分页存储管理、分段存储管理和段页式存储管理`。

1. 分页存储管理的基本原理

   - 基本概念

     - 1）页：逻辑上的划分，进程空间管理上的划分。
       - 页是操作系统分配内存的最小单位
     - 2）页框：物理上的划分，内存中的划分，又称为存储块、页帧
       - 页与页框的关系：
         - 页的大小与页框大小完全相等
         - 进程除了最后一个页可能会产生碎片，其他页都是刚好装入各个页框中
         - 页的编号在逻辑地址上是连续的，在页框分布上是离散的
         - 页在进程中在逻辑上是连续的，页框在内存中在物理上是离散分布的
     - 3）分页存储：在为进程分配内存时，以页框为单位，把进程中的若干页装入内存多个不一定相邻的页框中
     - 4）页内碎片：进程的最后一页不满一页框，形成了不可利用的碎片
     - 5）页表：记录进程页和内存页框的对应关系

   - 基本分页存储管理方式中的地址结构

     - 基本分页的逻辑地址结构包含两部分：页号 P + 页内偏移量 W
       - 页号即第几页，页内地址即页内偏移量
       - 地址计算方法

   - 分页地址变换

     - 地址变换过程，四个步骤

   - 页大小的选择

     - 页大小设计的影响因素
       - 管理内存的开销
       - 内存的利用率
       - 页大小：一般是 2 的 n 次幂，通常为 512B~4KB

2. 快表

   - 什么是快表
   - 引入 TLB 之后的地址变换过程
   - 引入 TLB 的性能分析

3. 两级和多级页表

   - 两级页表
   - 多级页表结构

4. 反置页表

   - 反置页表
   - 反置页表的地址映射

5. 空闲页框的管理
   - 使用位图管理空闲页框
   - 使用空闲页框的链表

## 4.5 基本分页的虚拟存储系统

## 4.6 分段存储管理

## 4.7 Linux 的伙伴系统

## 思考与练习

## 参考链接

- [存储器层次结构](https://zhuanlan.zhihu.com/p/92286186)
