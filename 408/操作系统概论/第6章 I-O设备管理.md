## 6.1 I/O 系统的组成

- 计算机系统中的 I/O 设备即输入/输出设备是用于计算机系统与人通信或与其他机器通信的所有设备，以及所有外存设备。I/O 设备管理是操作系统的重要功能之一，也简称为设备管理。
- 计算机 I/O 设备的多样性使得设备管理非常复杂
  - 设备种类繁多、物理特性多样、控制复杂、与主机速度不匹配
- I/O 设备管理的任务
  - 完成 I/O 请求，提高 I/O 速率，提高 I/O 设备利用率
- I/O 设备管理的主要功能
  - 设备控制、缓冲区管理、设备分配、实现设备独立性、虚拟设备

1. I/O 系统结构

   - 微机 I/O 系统，总线型
     - 现代总线设计：存储总线（北桥）+ I/O 总线（南桥）
   - 主机 I/O 系统，四级结构
     - I/O 系统可能采用四级结构，包括主机、通信、控制器和设备
     - 一条数据通路：内存——通道——控制器——设备

2. I/O 设备的分类

   - 按传输速率分类

     - 低速设备，速率 1KB/s 以下，典型设备有键盘、鼠标等设备
     - 中速设备，速率 1KB——100KB/s，典型设备有行式打印机、激光打印机
     - 高速设备，速率 1000KB/s 以上，甚至几十兆字节，典型设备有磁带机、磁盘机、光盘机等

   - 按信息交换的单位分类

     - 块设备，用于存储信息，以数据块为单位，典型设备是磁盘
     - 字符设备，用于数据的输入和输出，传送字节流，典型设备是终端、鼠标

   - 按设备的共享属性分类

     - 独占设备：必须作为临界资源以互斥方式访问的设备
     - 共享设备：允许多个用户共同使用，并发使用，典型设备是硬盘
     - 虚拟设备：通过某种虚拟技术把一台物理设备变成若干逻辑设备

3. 设备控制器

   - 什么是设备控制器

     - 一个计算机实体：可以嵌在主板、独立板卡或嵌入设备
     - CPU 与 I/O 设备之间的接口
     - 控制多个 I/O 设备
     - 实现 I/O 设备与主机的数据交换
     - 可编址设备，通过 I/O 地址识别不同的设备

   - 设备控制器的功能

     - 接收和识别命令
     - 数据交换
     - 标识和报告设备的状态
     - 地址识别
     - 数据缓冲
     - 差错控制

   - 设备控制器的组成
     - 1）设备控制器与处理机的接口：数据线、控制线、地址线
     - 2）设备控制器与设备的接口。含数据信号、状态信号、控制信号
     - 3）I/O 逻辑，包含指令译码器、地址译码器

4. I/O 通道

   - I/O 通道是一种特殊的处理机，是一个硬件设备

     - 具有执行 I/O 指令的能力
     - 通过执行通道（I/O）程序控制 I/O 操作
     - 指令类型单一，主要限于与 I/O 操作有关的指令
     - 没有自己的内存，通道程序放在主机内存中

   - I/O 通道使 CPU 从控制 I/O 任务中解脱
     - CPU 与 I/O 并行
     - 提高 CPU 利用率
     - 提高系统吞吐量

## 6.2 I/O 的控制方式

- I/O 控制方式的目标是尽量减少主机对输入/输出控制的干预，提高主机与输入/输出的并行程度，以提高整个系统的性能。
- I/O 控制的步骤
  - 设备启动
  - 传输参数初始化
  - 传输过程的控制
  - 传输结束
- I/O 控制改进的总体思路：尽量释放 CPU，减少 CPU 负担

- I/O 控制的方式
  - 1.轮询
  - 2.中断
  - 3.DMA 控制方式
  - I/O 控制三种比较

## 6.3 缓冲管理

1. 缓冲的引入

   - 引入缓冲区的两个主要原因

     - 处理数据流的生产者和消费者之间的速度差异
     - 协调传输数据大小不一致的设备，常见于网络传输

   - 引入缓冲区解决的问题
     - 缓和 CPU 与 I/O 设备间速度不匹配的矛盾
     - 降低 CPU 中断频率要求，放宽对 CPU 中断响应时间的限制
     - 提高 CPU 和 I/O 设备之间的并行性

2. 单缓冲

   - 运行周期：Max(C, T) + M

3. 双缓冲

   - 运行周期：Max(C+M, T)，增加了复杂性
   - C+M< T：主机速度快，主机等待，磁盘连续输入
   - C+M> T：磁盘速度快，磁盘等待，主机连续运行

4. 循环缓冲
   - 三类缓冲区：空白 R、装满 G、执行 C
   - 三个指针：指向三类缓冲区，Nexti，Nextg，current
   - 外部进程：生产者进程、消费者进程
   - 内部操作过程：
     - 读/写数据 Getbuf（面向不同进程提供不同 buffer）
     - 修改状态 Releasebuf
   - 进程同步控制：
     - Nexti 赶上 Nextg
     - Nextg 赶上 Nexti
   - 缓冲池
     - 三种缓冲区：空闲、输入数据、输出数据
     - 三个队列：空缓冲队列、输入队列、输出队列
     - 两个进程：PutBuf 和 GetBuf
     - 四种工作方式：收容输入、提取输入、收容输出、提取输出

## 6.4 设备分配

- 设备分配程序基于一定策略，把设备分配给用户
- 设备分配需要：
  - 记录设备情况的数据结构
  - 设备分配算法

1. 设备分配中的数据结构

   - 逻辑设备表 LUT
   - 设备控制表 DCT
   - 控制器控制表 COCT
   - 系统设备表 SDT
   - 通道控制表 CHCT（系统支持）

2. 设备分配

   - 设备分配考虑的 3 个因素
     - 设备固有属性：独占、共享、可虚拟
     - 设备分配算法：FIFO、基于优先权
     - 设备分配时的安全性：安全分配、不安全分配

3. 设备独立性

   - 设备独立性，即设备无关性，应用程序独立于具体使用的设备
     - 设备独立性的好处
       - 无关性
       - 易于处理故障
       - 提高软件可靠性、灵活性
     - 设备独立软件的功能
       - 执行所有设备的公有操作
       - 向用户层软件提供统一的接口

4. 独占设备的分配程序

   - 三步：分配设备；分配控制器；分配通道

5. SPOOLing 技术
   - 利用一道程序模拟脱机输入时外围控制机功能，I/O 设备数据传入磁盘
   - 利用一道程序模拟脱机输出时外围控制机功能，磁盘数据传出 I/O 设备
   - SPOOLing 系统组成
   - SPOOLing 系统特点

## 6.5 I/O 软件原理

- I/O 软件总体目标
  - 把软件组织成层次结构
  - 低层软件屏蔽硬件具体细节
  - 高层软件向用户提供简洁规范界面
- 设备管理软件组织 4 个层次
  - 用户进程
  - 设备无关软件
  - 设备服务程序
  - 中断处理程序

1. 设备管理软件的功能

   - 实现 I/O 设备的独立性
   - 错误处理
   - 异步传输
   - 缓冲管理
   - 设备的分配和释放
   - 实现 I/O 控制方式

2. 中断处理程序

   - 完成进程阻塞和释放 CPU

3. 设备驱动程序

   - 磁盘驱动工作过程

4. 与硬件无关的 I/O 软件

## 6.6 磁盘管理

- 磁盘管理目标：提高磁盘空间利用率和磁盘访问速度

1. 磁盘结构

   - 数据的组织和格式
     - 盘片
     - 磁道
     - 扇区
   - 磁盘类型
     - 固定头磁盘，每条磁道都有磁头，用于大容量磁盘
     - 移动头磁盘，一个盘面配有一个磁头，用于中小型磁盘
   - 磁盘访问时间
     - 寻道时间：磁头移动到指定磁道上的时间
       - 启动磁臂时间 s 与磁头移动 n 条磁道花费的时间之和 Ts=m\*n+s，m 是常数，与磁盘驱动器的速度有关；磁臂的启动时间 s 约为 2ms
       - 一般寻道时间 5~30ms
     - 旋转时间：扇区移动到磁头下面的时间
       - 5400 转硬盘，即 5400r/min，每转需时 11.1ms，平均旋转延迟时间 Tr 为 5.55ms
       - 万转硬盘的旋转时间约 2-3ms
     - 传输时间：数据从磁盘读出或写入磁盘
       - 与每次所读/写的字节数 b 和旋转速度有关
       - r 为磁盘每秒钟的转数；N 为一条磁道上的字节
     - 磁盘访问时间=寻道时间+旋转时间+传输时间
   - 提高磁盘 I/O 速度的方法
     - 提升磁盘硬件性能
     - 采用好的调度算法
     - 设置磁盘高速缓冲区

2. 磁盘调度

   - 磁盘属于共享设备，允许多个进程访问，因此需要磁盘调度算法
   - 磁盘调度算法目标是平均寻道时间少
   - 磁盘调度算法
     - 先来先服务（FCFS）
     - 最短寻道时间优先（SSTF）
     - 扫描（SCAN）算法
     - 循环扫描（CSCAN）算法
     - NStepSCAN 和 FSCAN 算法

3. 提高磁盘 I/O 速度的算法

   - 提前读
   - 延迟写
   - 优化物理块的分布
   - 虚拟盘
   - 磁盘高速缓存

## 思考与练习
