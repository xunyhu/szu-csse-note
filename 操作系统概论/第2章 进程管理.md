# 第二章 进程管理

操作系统本身就是一种软件，本质上就是数据结构加算法。

操作系统重最核心的概念就是进程，操作系统的其他所有内容都是围绕进程展开的。

## 第一节 进程的描述

pdf-49, 教材 p43

#### 一、程序的并发执行

1. 程序的顺序执行

   特点：1.顺序性：下一步操作要等待前一操作结束；2.封闭性：执行独占资源，不受外界影响；3.可再现性：重复执行将获得相同结果。

2. 程序的并发执行

   含义：程序并发执行是指在`同一时间间隔`内运行多个程序，一个程序执行结束之前，可以运行其他程序。

   特点：1.间断性；2.失去封闭性；3.不可再现性

#### 二、进程的概念

当操作系统支持程序并发执行时，并发执行的程序可能是同一个程序在不同数据集合上的执行，也可能是不同的程序在不同数据集合上的执行，它们共享系统资源。用程序已不能描述程序的并发执行，所以引入了进程的概念。

1.  **进程的定义**

    定义 1：进程是允许并发执行的程序在某个数据集合上的`运行过程`

    定义 2：进程是由`正文段`、`用户数据段`及`进程控制块`共同组成的**执行环境**

         正文段：描述进程要完成的功能，存放机器指令
         数据段：进程执行时直接进行操作的用户数据
         进程控制块 PCB：存放程序的运行环境

2.  **进程的特征**

    1）并发；2）动态；3）独立；4）异步；5）结构特征

        并发：多个进程同时执行，现代操作系统的重要特征
        动态性：进程实体的执行过程，创建——执行——消亡
        独立性：资源独立，互不干扰
        异步性：速度不可预知，执行随机
        结构特征：进程由正文段、用户数据段、进程控制块组成

3.  进程与程序的比较

    含义：进程是程序的一次执行，进程总是对应至少一个特定的程序，执行程序的代码。

    进程与程序的比较

         进程是动态的，程序是静态的
         进程是暂时，程序是永久
         存在实体不同，程序是指令集合，进程由正文段+数据段+PCB 组成

    进程与程序的联系

         进程是程序的一次执行
         一个程序可以对应多个进程（一个程序对应不同数据集合运行多个进程；多个进程并发执行同一个程序代码）

**真题**

1. 进程是程序的执行过程，存在被创建、被执行、被撤销的变化过程，即进程具有`动态性`
2. 程序在并发执行时，由于它们共享资源，导致程序的执行时时断时续的，因此失去了`封闭性`
3. 下面不属于进程的特征的是`静态性`
4. 某计算圆周率的程序（无输入但输出值一样）在同一个 Windows 机器上第一次运行耗时 3 分钟，第二次运行耗时 5 分钟，这体现了程序并发执行的哪个特点？`间断性`
5. 程序`顺序执行`的特点不包括`间断性`
6. 现代操作系统具有并发的特征，主要是由于引入了`多道程序系统`

   多道程序系统的主要特点即是进程的并发执行。

#### 三、进程控制块（PCB）

1.  什么是进程控制块（Process Control Block, PCB）

    进程控制块是进程实体的一部分，是操作系统中最重要的数据结构。进程控制块中记录了操作系统所需要的、用于描述进程情况及控制进程运行所需的全部信息。

    操作系统在创建进程时，首先要为进程创建进程控制块，也就是生成一个进程控制块类型的变量，以存储所创建进程的描述信息。`每个进程有唯一的进程控制块`，进程控制块是`操作系统感知进程存在的唯一标志`。

2.  进程控制块中的信息

    不同操作系统进程控制块种包含的描述信息不完全相同，一般操作系统中的进程控制块中通常包含以下信息。

    1）进程标识符信息；

        进程标识符用于唯一标识一个进程。进程控制块中除了存有本进程的标识符外，还存放其父进程、子进程的标识符。

    2）处理机状态信息；

        处理机是被进程共享的资源，当一个进程在CPU上执行，发生进程切换时必须将当前进程的CPU寄存器值保存到内存中，以便该进程再次获得CPU时能从内存中加载寄存器的值，恢复进程上次被暂停时的CPU环境从上次被中断处继续执行。进程控制块中保留的处理机状态信息通常包括：

        1. 通用寄存器。用户程序访问的寄存器，用于暂存信息。
        2. 指令计数器。其中存放了CPU要访问的下一条指令的地址。
        3. 程序状态字PSW。其中包含状态信息，如条件码、执行方式和中断屏蔽标志等。
        4. 用户栈指针。每个用户进程都有一个与之相关的系统栈，用于存放过程和系统调用参数及调用地址，栈指针指向该栈的栈顶。

    3）进程调度信息；

        进程调度信息包括进程状态信息、进程优先级和进程调度所需的其他信息。

    4）进程控制信息

        进程控制信息包括程序和数据的地址、进程同步和通信机制、资源清单，以及链接指针。

#### 四、**进程的状态**

pdf-53, p47

1.  进程的 3 种基本状态

    1）就绪态：已经获得 CPU 以外所有资源，处于就绪队列

    2）执行态：获得 CPU，处于执行过程。

         单 CPU 系统中，任意时刻只能有一个进程处于执行态。有 N 个 CPU 的多 CPU 系统中，任意时刻系统中最多有 N 个进程处于执行态。

    3）阻塞态：发生某种事件暂时无法进行，放弃 CPU 处于暂停状态，如请求 I/O，请求缓冲空间，处于阻塞队列

2.  进程状态的转换

    新创建的进程状态一般被设置为就绪态，当操作系统为处于就绪态的进程分配 CPU 时，进程开始在 CPU 上运行，进程由就绪态变为执行态。  
    执行态进程可能变为就绪态，也可能变为阻塞态。  
    进程在创建后到撤销前，其状态可能多次在 3 个状态之间装换。进程状态不能由阻塞态直接变为执行态，进程状态由阻塞态变为就绪态的过程称为唤醒过程，由执行态变为阻塞态的过程称为阻塞过程。

3.  Linux 的进程状态

#### 五、进程的组织

在操作系统中任意时刻都可能存在很多进程，每个进程对应一个进程控制块，操作系统组织和管理进程是通过管理和组织进程控制块来实现的。  
实际上对进程的组织是通过定义数据结构来实现的。

1. 链接方式
2. 索引方式
3. 进程队列

**真题**

1. 如果有 N（N>2）个进程并发运行，则不可能出现的情形是`没有进程处于执行态，2个就绪态的进程，N-2个阻塞态的进程`

   当没有进程处于执行态时，就绪态的进程会进入。

2. 进程所请求的一次打印输出完成后，进程的状态会从`阻塞态变为就绪态`

   请求的 I/O 事件完成后，进程从等待状态变为就绪状态。等待状态即为阻塞状态。

3. 进程从执行状态进入就绪状态的原因可能是`时间片用完`

   运行中的进程可以处于以下 3 种状态之一：运行、就绪、等待。运行状态是指进程已获得 CPU，并且在 CPU 上执行的状态。就绪状态是指一个进程已经具有运行条件，但由于没有获得 CPU 而不能运行所处的状态。等待状态是指进程因等待某种事件发生而暂时不能运行的状态。当时间片用完时，进程从运行状态进入就绪状态。

## 第二节 进程的控制

#### 一、进程的创建

创建新进程包括为进程分配必要的资源，建立操作系统用于管理进程的数据结构等操作。通常在下列清空下需要创建新进程：

    1）用户登录：winlogon
    2）作业调度
    3）提供服务
    4）应用请求：Unix 的 fork()，Win 的 CreatProcess()

调用创建新进程的`系统调用`来创建进程的一般步骤如下：

    1）申请空白 PCB
    2）为新进程分配资源
    3）初始化进程控制块
    4）将新进程插入就绪队列

进程创建的关系

    父进程：由系统或用户首先创建的进程
    子进程：父进程创建的进程
    父子进程关系：
        进程控制：子进程由父进程创建或撤销，子进程不能控制父进程
        资源继承：子进程可以全部或部分共享父进程的资源
        运行方式：可同时进行，可以控制先后
        数据结构：在 PCB 中设置家族关系表项，标明自己的父进程和子进程。

进程相关的系统命令

    Windows
      TASKLIST， tasklisk - svc，tasklist -n
      TSKILL
      NTSD -c q -p PID
    Linux
      程序使用 fork()函数创建进程
      系统调用是 clone 和 vfork

#### 二、进程的阻塞

操作系统在下列情况下可能进行进程的阻塞和唤醒操作：

    1）请求系统服务
    2）启动某种操作
    3）新数据尚未到达
    4）无新工作可做

进程阻塞的过程

    1）将进程的状态改为阻塞态
    2）将进程插入相应的阻塞队列
    3）转进程调度程序，从就绪进程中选择进程为其分配 CPU

#### 三、进程的唤醒

操作系统通过下列过程将阻塞态进程唤醒，使其变为就绪态进程。进程唤醒的过程如下。

    1）将进程从阻塞队列中移出
    2）将进程状态由阻塞态改为就绪态
    3）将进程插入就绪队列

#### 四、进程的终止

进程终止的起因

     正常结束：halt、Logoff
     异常结束：越界错误、保护错、非法指令、特权指令错、运行超时、等待超时、算术运算错、I/O 故障
     系统调用：操作员或 OS 干预、父进程请求或父进程终止

进程终止的过程

     从进程 PCB 中读进程状态
     若进程正在执行，则终止进程的执行
     若进程有子孙进程，在大多数情况下需要终止子孙进程
     释放资源
     将终止进程的 PCB 移出

#### 五、操作系统的启动和系统中进程的出现

操作系统的启动和进程变化

- 硬盘启动

  如果是单系统，引导扇区是 0 柱面 0 磁道 1 扇区，BIOS 将它装入到内存，并开始加载操作系统。
  如果是多分区多系统，主引导扇区是 0 柱面 0 磁道 1 扇区，会通过它判断当前激活分区，再加载相应的操作系统。

- OS 启动

## 第三节 操作系统内核

操作系统是计算机硬件的第一次扩充，内核执行操作系统与硬件关系密切，执行频率高的模块，常住内存。操作系统内核的功能：

    1.支撑功能

        支撑功能包括中断处理、时钟管理和原语操作。原语操作也称为原子操作，是一组在执行过程中不能被中断的操作。

    2.资源管理功能

        资源管理包括进程管理、存储管理和设备管理。

#### 中断

1. 什么是中断

   中断是改变处理器执行指令顺序的一种事件，这样的事件与 CPU 芯片内外部硬件电路产生的电信号相对应。

2. 为什么需要中断

   引入中断机制后，使 CPU 可以与其他设备并行工作，能有效提高 CPU 的利用率，改善系统性能，支持系统的异步性。

3. 中断的类型

   中断分为同步中断（也称内部中断或异常）和异步中断（也称外部中断）两种。  
   1）同步中断  
    之所以称为同步，是因为只有在一条指令终止执行后 CPU 才会发出中断，如除法出错、调试、溢出和浮点出错等。
   2）异步中断  
    异步中断是由其他硬件设备随机产生的。外部中断又可以分为外部可屏蔽中断和外部不可屏蔽中断。

4. 引起中断的原因

   1）人为设置中断。在程序中人为设置中断。  
   2）程序性事故。例如，计算中出现除数为 0。  
   3）硬件故障。插件接触不良、电源掉电等。  
   4）I/O 设备。I/O 设备准备就绪或完成一次输入/输出，便向 CPU 发出中断请求。  
   5）外部事件。如用户通过键盘和鼠标来中断现行程序。

5. 中断响应

   1）响应中断的条件  
    对于可屏蔽中断，开中断是响应中断的前提。  
   2）响应中断的时机  
    对于外部中断，CPU 每执行完一条指令都会检测是否有外部中断信号的到来。若有，则转中断处理过程。

6. 单重中断的处理过程

   以单重中断为例，简单说明外部中断处理的过程。假定在中断处理的过程中不再响应新近产生的中断信号，直到本次中断处理完毕。

   中断处理过程：1）系统关闭中断；2）转中断处理程序；3）执行中断处理子例程；4）最后，恢复现场，开中断，CPU 返回断点处继续执行被中断的程序。

7. 如何找到中断服务子程序

   1）中断向量；  
   2）中断描述符表是一个系统表，每一个终端或异常与向量相联系。

#### 时钟管理

1. 时钟的重要性

   时钟是计算机系统的脉搏。计算机的很多活动都有由定时测量来驱动的。

2. 计算机系统中的时钟

   大部分 PC 中有两个时钟源，分别称为实时时钟（Real Timer Clocker, RTC）和 OS 时钟。RTC 时钟也称 CMOS 时钟，是一块时钟芯片，靠电池供电，为计算机提供计时标准，是最原始、最底层的数据。OS 时钟产生于 PC 主板上的定时/计数芯片，在开机时有效，由操作系统控制。

3. 操作系统的时钟机制

   操作系统内核需要完成两种主要的定时测量  
    一是保存当前的日期和时间，以便能通过系统调用把它们返回给用户程序，让用户程序获得当前的日期和时间，也可以由内核本身把当前时间作为文件和网络包的时间戳。  
    二是维持定时器，这种机制能够告诉内核或用户程序某一时间间隔已经过去了。

   操作系统依靠时钟硬件（可编程间隔定时器 PIT）和时钟驱动程序完成上述两种定时测量功能。

   1）OS 时钟管理硬件（可编程间隔定时器 PIT）  
   2）时钟软件——时钟驱动程序

4. Linux 时钟

#### 系统调用

1. 什么是系统调用

   系统调用是一群预先定义好的模块，它们提供一条管道让应用程序或一般用户能由此得到核心程序的服务。系统调用是系统程序与用户程序之间的接口。

2. 系统调用与一般函数的区别

   为了说明系统调用与一般函数的区别，先说明什么是用户态执行，什么是系统态执行。  
   1）用户态执行  
    用户空间是指用户进程所处的地址空间，一个用户进程不能访问其他进程的用户空间，只有系统程序才能访问其他用户空间。  
   2）系统态执行  
    系统空间是指含有一切系统核心代码的地址空间，当 CPU 执行系统核心代码时，称进程处于系统态执行。

   系统调用与一般函数调用的区别如下。  
   1）系统调用运行在系统态（核心态），而一般函数运行在用户态。  
   2）系统调用与一般函数调用的执行过程不同。系统调用执行时，当前进程被中断，由系统被相应的系统调用子程序，并在系统态下执行，执行结果返回进程。  
   3）系统调用要进行“中断处理”，比一般函数调用多了一些系统开销。

3. 普通函数执行过程实例
4. 系统调用执行过程实例
5. 系统调用的类型
6. Linux 中的系统调用举例
7. 操作系统提供系统调用的优点

**真题**

1. 以下功能中，`不是`由时钟驱动程序完成的是`把时间片用完的进程转入就绪态`
2. 中断处理时，对不同中断源到来的信号进行编号，该编号被称为`中断向量`
3. 下列关于系统调用与函数调用的说法正确的是`系统调用运行在核心态，而函数调用运行在用户态`
4. 处于执行态的进程，其进程控制块中时间片的长度值`>0`
5. 操作系统内核与应用程序之间的接口是`系统调用`
6. 下列不是操作系统内核基本功能的是`文件管理`
   - 操作系统内核基本功能包括与硬件密切相关的时钟管理、中断机制、原语以及系统控制的数据结构以及处理（进程管理、存储器管理、设备管理）。

## 第四节 **进程同步**

pdf-70, p64

多任务操作系统支持多个进程并发执行，并发执行的进程共享系统的软件和硬件资源。操作系统同步机制的主要任务就是要保证在多任务共享系统资源的情况下，程序执行能得到正确的结果。

#### 进程同步的基本概念

在多道程序环境下，进程之间可能存在资源共享关系和相互合作关系。进程同步有两个任务，一是对具有资源共享关系的进程，保证诸进程以互斥的方式访问临界资源。`临界资源是必须以互斥方式访问的共享资源`。二是对具有相互合作关系的进程，保证相互合作的诸进程协调执行。相互合作的进程可能同时存在资源共享的关系。

#### 同步机制应遵循的准则

1. 空闲让进
2. 忙则等待
3. 有限等待
4. 让权等待：释放 CPU、避免忙等

#### 信号量机制

在信号量机制中，用某种类型的变量，即信号量的取值来表示资源的使用状况，或某种事件是否发生，以此为基础`实现进程的同步`。

1. 整型信号量机制

   使用一个代表资源数目的整型变量，即一个信号量且是整数变量。  
   两个标准原子操作访问信号量：wait(S)和 signal(S)，坚持 P、V 操作

2. 记录型信号量机制

   记录型信号量机制的优点是不存在“忙等”，采取了“让权等待”的策略。

3. AND 型信号量机制

#### 经典的进程同步问题

1. **生产者-消费者问题**
2. **读者-写者问题**

#### 管程

信号量机制的缺陷是每个访问共享资源的进程都必须自备同步操作 wait(s)和 signal(s)。这就使大量的同步操作分散在各个进程中，这不仅给系统的管理带来麻烦，而且还会因同步操作的使用不当而导致系统出错，因此引入了管程的概念。

1. 管程的基本概念

   管程是描述共享资源的数据结构和在数据结构上的共享资源管理程序的集合。

2. 管程的应用

   1）利用管程解决生产者——消费者问题  
   2）利用管程解决哲学家进餐问题

**真题**

1. 如果进程 P 在等待打印机的时候，出现了长时间等待也无法获得该资源的情况，则违反了准则`有限等待`
2. 临界区是`一段程序`  
   在多道程序系统环境中，各进程可以共享系统中的各类资源，但有些资源一次只能供一个进程使用，称为临界资源（Critical resource，CR），如打印机、共享变量、表格等。临界区（Critical Section，CS）是进程中对临界资源实施操作的那段程序。
3. 处于执行态的进程，其进程控制块中时间片的长度值`>0`
4. 在操作系统中，要对甲、乙两个并发进程进行同步的原因是`甲、乙两个进程需要访问临界资源`

## 第五节 进程通信

pdf-86, p80

操作系统提供进程通信功能，以支持进程之间的信息交换。进程之间的高级通信机制：分为共享存储器系统、消息传递系统和管道通信系统。  
信号量机制属于进程间的低级通信

1. 共享存储器系统

   在共享存储器系统中，相互通信的进程共享某些数据结构或共享存储区，进程之间能够通过这些空间进行通信。共享存储系统可分为两种类型。  
    1）共享数据结构；2）共享存储区

2. 消息传递系统

   直接通信方式；间接通信方式

3. 管道通信

   以文件方式连接读写进程

4. 消息缓冲队列

   广泛应用本地进程通信  
   包括数据结构、发送原语、接收原语

## 第六节 线程

在传统的操作系统中，进程是进行资源分配和独立执行的基本单位。为了进一步提高程序的并发性，减少系统开销，在操作系统中引入了线程的概念。  
线程的实质是把进程的任务划分为更小、具有独立功能的单位，以线程的形式来并发执行，以提高程序并发执行的程度。

#### 线程的描述

1. 线程的概念和分类

   1）线程的概念  
    线程是进程的一个实体，是独立调度和分派的基本单位；线程作为利用 CPU 的基本单位，是花费开销最小的实体；线程只包含运行所需的资源，即 CPU 资源，但它可以共享进程资源。  
    一个线程可以创建和撤销另一个线程。同一个进程的多个线程可以并发执行。线程在运行中呈现间断性，也有就绪、阻塞和执行 3 种基本状态。

   2）线程的分类  
    线程的实现可以分为两类，即用户级线程和内核级线程。内核级线程依赖于内核，用户进程和系统进程中的线程，它们的创建、撤销和切换都由内核实现。在内核中为线程创建线程控制块，内核根据该控制块感知线程的存在并对线程进行控制。  
    内核级线程与用户级线程比较。

2. 线程的 3 种基本状态
3. 线程控制块

   1）线程控制块的定义  
    每个线程都由一个数据结构表示，包括它的基本状态、标识及记账信息。这个数据结构就是线程控制块（Thread Control Block, TCB）  
   2）线程控制块中的信息  
   3）线程控制块的组织方式

4. 线程与进程的关系

#### 线程的控制

1. 线程创建
2. 线程的终止
3. 线程的调度与切换
4. 线程的阻塞与唤醒

#### 线程的同步

类似进程，有原语操作、信号量机制

#### 线程通信

同一进程的线程之间，直接用全局变量通信  
不同进程的线程之间，使用操作系统提供的线程通信机制

## 思考与练习

#### 填空题

1. 进程是由正文段、` `和` `构成的实体。
2. 进程的 3 种基本状态是执行态、`就绪`态和`阻塞`态。
3. 整型信号量的值只能被` `和` `改变，不允许系统中的其他程序改变信号量的值。
4. 临界区是指访问` `的代码。

#### 简答题

1. 什么是进程？说明进程与程序的区别与联系。
2. 操作系统在什么时候创建进程？操作系统如何创建一个进程？
3. 时钟中断信号是如何产生的？时钟中断处理程序（时钟驱动程序）的功能是什么？
4. 请说明单重中断的处理过程。
5. 进程具有哪些特征？
6. 什么是线程？为什么要引入线程？
7. 实现进程互斥的基本原理是什么？

## 简答题复习

1. 进程的定义
2. 进程的特征
3. 进程与程序的比较
4. 进程与程序的联系
5. 进程控制块中的信息
6. 进程 3 种基本状态
7. 操作系统内核包括的功能：两种功能具体描述
8. 单重中断的处理过程
9. 时钟驱动程序完成功能：4 步
10. 高级通信机制：4 种
11. 线程的 3 种基本状态：3 种具体描述
12. 线程控制块的描述：3 部分
