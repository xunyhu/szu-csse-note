## 第四章 网络层

### (一)、网络层服务

网络层是介于传输层与数据链路层之间，传输层提供端到端的进程间通信服务，数据链路层提供物理链路层直接相连的两个结点之间的数据帧传输服务，**网络层关注的是如何将承载传输层报文段的网络层数据报从源主机送达目的主机。**

1. 转发。通过一条输入链路接收到一个分组后，路由器需要决策通过哪条输入链路将分组发送出去，并将分组从输入接口转移到输出接口。
2. 路由选择。当分组从源主机流向目的主机时，必须通过某种方式决定分组经过的路由或路径，计算分组所经过的路径的算法被称为路由选择算法，或称为路由算法。
3. 路由器转发表
   - 交换或收集路由信息
   - 计算路由
   - 路由信息存储在转发表

### (二)、数据报网络与虚电路网络

**网络层服务分为：数据报服务、虚电路服务**

1. 数据报网络
   - 需要路由
   - 无连接服务
   - 因特网属于数据报网络
2. 虚电路网络
   - 面向连接的分组服务
   - 虚电路是网络层的逻辑连接，区别于电路交换
   - 每条虚电路有虚电路号**VCID**
3. 虚电路三个要素
4. 虚电路分组交换两种类型：永久型、交换型
5. 虚电路和数据报的区别

### (三)、网络互连与网络互连设备

1. 异构网络概念，互连策略
   - 协议转换
   - 构建虚拟互连网络
2. IP 网络、Internet 都是虚拟互联网
3. 网络互连设备
   - 协议转换的交换机和网桥
   - 多协议路由器
   - 应用网关
4. Internet 的网络互连设备——IP 路由器
5. 网络互连典型技术——隧道技术
6. 路由器功能结构
   - 输入端口，数据报封装在链路层的帧中
   - 交换结构，三种交换结构，三种交换结构的性价比
   - 输出端口，从链路层的帧组装成数据报
   - 路由处理器，路由的两项最重要功能

### (四)、网络层拥塞控制

1. 流量感知路由，属于拥塞预防
   - 网络中链路权值根据网络负载动态调整
   - 改进方法：多路径路由，负载逐步迁移法
2. 准入控制，广泛应用于虚电路网络，属于拥塞预防
   - 虚电路审核，根据平均流量和瞬时流量判断是否建立新的虚电路
3. 流量调节，属于拥塞消除
   - 抑制分组 + 背压
4. 负载脱落，属于拥塞消除
   - 选择丢掉哪些数据报，根据应用类型决定丢掉新的还是旧的
   - 文件传输适合丢新的，视频流适合丢旧的

### (五)、Internet 网络层

1. Internet 网路层主要协议：**IP 协议、路由协议、ICMP 协议**  
   IPv4 结构表格与字段含义
2. IP 数据报分片计算公式
   - MTU 最大 1500 字节
   - 片偏移/标志 MF/标志 DF 的含义
   - 掌握 P146-147 实例，理解表格计算
3. IPv4 编址格式：
   - 长度是 32bit，常用四个十进制数方便表示，以"."分隔
   - 每个整数对应 8bit 二进制码，所以每个整数范围 0~255
   - 十进制整数是为了方便用户记忆，实际上网络底层全部用二进制表示
   - 还有十六进制表示方式
4. 掌握 IP 地址三种格式的转换
   - 熟背十进制转二进制
   - 2^4=16,2^5=32,2^6=64,2^7=128,2^8=256,2^9=512,2^10=1024
5. 一个**IP 地址分为两个部分：子网地址（前缀）+ 主机地址（后缀）**  
   IPv4 分类地址：前缀部分长度固定，分为 ABCDE
   - A 类，1+3，首数字 0-127（第一位 10 进制数，8 个 0~8 个 1）
   - B 类，2+2，首数字 128-191
   - C 类，3+1，首数字 192-223
   - D 类，特殊用途，首数字 224-239
   - E 类，特殊用途，首数字 240-255
   - 熟背 ABC 类的网络数量和 IP 地址总数
6. 子网划分，采用 CIDR 技术，通过子网掩码标识子网地址长度
   - 子网表示一段范围内的 IP 地址，子网内的 IP 直接相互通信，无需再寻址
   - **IP 地址=子网地址+主机地址/子网掩码**
     - 子网地址格式上是一个 IP 地址，含义是一个子网，表示一段范围内的 IP
     - 主机地址格式上是一个 IP 地址，含义是一个子网中某台电脑的 IP
     - 子网掩码格式上是一个 IP 地址，含义是表示子网的范围
     - 子网地址=IP 地址 and 子网掩码
   - 子网掩码的含义
     - 子网掩码是 32bit 中，前 n 个位是 1，后（32-n）个位是 0，不存在 0 与 1 混杂，必定是前 1 后 0
     - 若掩码中 1 个数是 x，则 2^(32-x)表示子网的 IP 数
   - 给出任意 IP 地址和掩码长度 n,求解子网参数
     - 子网参数：子网掩码\子网地址\广播地址\IP 地址总数\可分配 IP 地址范围
     - 子网地址 = IP 地址 and 子网掩码
     - IP 地址总数 = 32-n，做 2 的 n 次方
     - 广播地址 = 子网地址 + IP 总数 - 1
     - 可分配 IP 地址 = IP 总数 - 2
     - 分配 IP 地址范围最小值 = 子网地址 + 1
     - 分配 IP 地址范围最大值 = 广播地址 - 1 = 子网地址 + IP 总数 - 2
     - 在一个子网段中，首尾四个 IP 地址含义
       - 第 1 个 IP 是子网地址，第 2 个 IP 是最小可分配 IP 地址
       - 倒数第 2 个 IP 是最大可分配地址，最后一个 IP 是广播地址
     - 以上公式是假设主机地址集中在 IP 的第 4 个数字
     - 如果主机地址跨越了 IP 第 3、4 个数字，要找出第 3 个数字表示主机的长度
       - 子网地址 = 公式不变
       - IP 地址总数 = 公式不变
       - 广播地址 = 前 2 个数字不变+第 3 数字+主机部分表示最大值+第 4 数字+255
       - 可分配 IP 地址 = 公式不变
       - 分配 IP 地址范围最小值 = 公式不变
       - 分配 IP 地址范围最大值 = 公式不变
   - 子网掩码划分子网
     - 子网掩码 32bit 从高到低，每把一个 0 变成 1，子网就划分为 2 个子网，IP 总数和 IP 范围就分为两半
     - 一般情况下，对半分的两个小子网规则
       - 第一个小子网的子网地址=原子网地址，原掩码+1,
       - 第二个小子网的子网地址=原子网地址+半 IP 总数，原掩码+1,
       - 这里的掩码加 1 是指 1 的个数加 1，不是十进制数值加 1
7. 路由聚合
8. 动态主机配置协议 DHCP
   - DHCP 服务过程
9. 网络地址转换 NAT
10. 互联网控制报文协议 ICMP
    - ICMP 报文格式
    - ICMP 报文类型
11. IPv6
    - IPv6 地址空间巨大
    - IPv6 地址格式
      - 长度是 128bit，用 8 组十六进制表示，每组 16bit 用 4 个十六进制数
      - 连续多组 0000 可以用::压缩表示，只能用一次
      - 最后 32bit 可以点分十进制混合表示，即十六进制和点十进制混合组合，或全点分十进制都可以

### (六)、路由算法与路由协议

1. 路由选择问题实际就是选择最佳路径
2. 把网络抽象成为带权无向图
3. 路由算法分为
   - 全局式路由选择，链路状态路由选择算法
   - 分布式路由选择，距离向量路由选择算法
4. 链路状态路由选择算法，迪杰斯特拉算法
5. 层次化路由选择 - 自治系统 - 自治系统间路由协议 - Internet 路由选择协议分为 IGP 和 BGP - IGP：RIP 协议、用跳数来衡量；OSPF 协议，基于链路状态选择算法； - BGP: BGP，BGP4
   **考核内容与要求**

- 网络层服务
  - 识记：网络层服务
  - 领会：网络层寻址；转发与路由的基本概念；转发与路由的区别与联系
- 数据报网络与虚电路网络
  - 识记： 虚电路网络特点；数据报网络特点
  - 领会：虚电路网络工作过程；数据报网络工作过程；虚电路网络的转发与路由；数据报网络的转发与路由；虚电路网络的转发表；数据报网络的转发表
- 网络互连与网络互连设备
  - 领会：网络互连的必要性；网络互连的基本方法；典型网络互连设备；路由器体系结构。
- 网络层拥塞控制
  - 识记：网络层拥塞基本概念；拥塞控制基本策略
  - 领会：流量感知路由基本原理；准入控制基本原理；流量调节基本方法；负载脱落基本原理
- Internet 网络层
  - 识记：Internet 网络层主要协议及其功能；IP 数据报结构。
  - 领会：MTU 的基本概念；特殊 IP 地址；私有 IP 地址；ICMP；DHCP；默认网关；NAT 的原理。
  - 应用：IP 数据报的分片；IP 地址；子网划分与子网掩码；CIDR；路由聚合；路由表。
- 路由算法与路由协议
  - 识记：路由选择基本原理；路由算法分类
  - 领会：链路状态路由算法基本原理；距离向量路由算法基本原理；层次化路由基本原理；RIP；OSPF；BGP。
  - 应用：基于链路状态路由算法的路由计算；基于距离向量路由算法的路由计算；距离向量路由算法的无穷计数问题分析。
    **重点、难点**  
    本章重点是转发与路由概念的理解、虚电路网络与数据报网络工作原理、IP 数据报结构、IP 数据报分片、IP 地址、子网划分、子网掩码、CIDR、路由聚合、路由表、ICMP、DHCP、NAT、链路状态路由算法、距离向量路由算法、层次化路由、RIP、OSPF、BGP 基本工作过程；
    本章难点是 IP 数据报分片、IP 地址、子网划分、子网掩码、CIDR、路由聚合、路由表、路由计算、层次化路由、OSPF、BGP。

#### 参考阅读

[深入理解计算机网络（四）：网络层](https://www.taogenjia.com/2019/09/05/computer-network-4-network-layer/)
